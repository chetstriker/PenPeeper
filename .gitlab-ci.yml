variables:
  GIT_STRATEGY: clone
  GIT_CLONE_PATH: "$CI_PROJECT_DIR"
  # Your specific LAN IP and port
  REPO_URL: "http://192.168.50.112:1080/root/penpeeper.git"

stages:
  - build
  - release

# ---------------------------------------------------------------------------
# WINDOWS BUILD JOB
# ---------------------------------------------------------------------------
windows_release:
  stage: build
  tags:
    - windows
    - flutter
  rules:
    - if: $CI_COMMIT_TAG
  before_script:
    - git remote set-url origin $REPO_URL
    - git fetch --all
    - git checkout $CI_COMMIT_SHA
  script:
    - flutter --version
    - flutter config --enable-windows-desktop
    - $CleanVersion = $Env:CI_COMMIT_TAG.TrimStart('v')
    - '(Get-Content pubspec.yaml) -replace ''^version: .*'', "version: $CleanVersion" | Set-Content pubspec.yaml'
    # Update Version in .ifp
    - '(Get-Content PenPeeper_Win_Installer.ifp) -replace ''<Version>.*?</Version>'', "<Version>$CleanVersion</Version>" | Set-Content PenPeeper_Win_Installer.ifp'
    # Update DisplayVersion in Registry
    - '(Get-Content PenPeeper_Win_Installer.ifp) -replace ''name="DisplayVersion" type="string">.*?</RegistryKey>'', (''name="DisplayVersion" type="string">'' + $CleanVersion + ''</RegistryKey>'') | Set-Content PenPeeper_Win_Installer.ifp'
    # Remove hardcoded sizes to avoid mismatch errors during extraction
    - '(Get-Content PenPeeper_Win_Installer.ifp) -replace ''size=".*?"'', "" | Set-Content PenPeeper_Win_Installer.ifp'
    - flutter pub get
    - flutter build web --release --wasm
    - flutter build windows --release

    # 1. Clean and Create Staging
    - if (Test-Path "C:\Temp\PenPeeper_Staging") { Remove-Item "C:\Temp\PenPeeper_Staging" -Recurse -Force }
    - New-Item -ItemType Directory -Force -Path "C:\Temp\PenPeeper_Staging"

    # 2. Copy Build Files to Staging
    - Copy-Item -Path "build\windows\x64\runner\Release\*" -Destination "C:\Temp\PenPeeper_Staging" -Recurse -Force

    # 3. Copy Web Assets to Staging
    - New-Item -ItemType Directory -Force -Path "C:\Temp\PenPeeper_Staging\build"
    - Copy-Item -Path "build\web" -Destination "C:\Temp\PenPeeper_Staging\build\" -Recurse -Force

    # 4. Copy Icon
    - Copy-Item -Path "assets\favicon.ico" -Destination "C:\Temp\PenPeeper_Staging\favicon.ico"

    # 5. Create Output Directory (for the installer)
    - New-Item -ItemType Directory -Force -Path "Output"

    # 6. Run InstallForge CLI Builder
    #    -i = Input (.ifp file)
    #    -o = Output (Setup executable)
    - '& "C:\Program Files (x86)\solicus\InstallForge\bin\ifbuildx86.exe" -i "PenPeeper_Win_Installer.ifp" -o "Output\PenPeeper_Setup_V$($Env:CI_COMMIT_TAG.TrimStart(''v'')).exe"'

    # 7. Copy installer to root for artifact (avoids subfolder in download)
    - Copy-Item -Path "Output\PenPeeper_Setup_V$($Env:CI_COMMIT_TAG.TrimStart('v')).exe" -Destination "."

  artifacts:
    name: "PenPeeper-Windows-$CI_COMMIT_TAG"
    paths:
      - "PenPeeper_Setup_V*.exe"
    expire_in: 30 days

# ---------------------------------------------------------------------------
# MACOS BUILD JOB (With Signing)
# ---------------------------------------------------------------------------
macos_release:
  stage: build
  tags:
    - macos
    - flutter
  rules:
    - if: $CI_COMMIT_TAG
  before_script:
    # Add common paths for Homebrew (Apple Silicon & Intel) and Ruby Gems
    - export PATH="$PATH:/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Library/flutter/bin"
    # Verify tools are found (helpful for debugging)
    - echo "Flutter path:" && which flutter
    - echo "CocoaPods path:" && which pod
    - git remote set-url origin $REPO_URL
    - git fetch --all
    - git checkout $CI_COMMIT_SHA
  script:
    - flutter --version
    - flutter config --enable-macos-desktop
    - export CLEAN_VERSION=${CI_COMMIT_TAG#v}
    - 'sed -i "" "s/^version: .*/version: $CLEAN_VERSION/" pubspec.yaml'
    - flutter pub get
    # Build web assets first, then macOS app
    - flutter build web --release --wasm
    - flutter build macos --release

    # Bundle web assets into the .app bundle
    - mkdir -p build/macos/Build/Products/Release/PenPeeper.app/Contents/Resources/build
    - cp -r build/web build/macos/Build/Products/Release/PenPeeper.app/Contents/Resources/build/

    # --- SIGNING STEP ---
    # If you do not have a paid Developer ID yet, comment out these two lines:
    - chmod +x scripts/sign_macos.sh
    - ./scripts/sign_macos.sh
    # --------------------

    # Copy DMG to root for artifact (avoids subfolder in download)
    - cp build/macos/Build/Products/Release/PenPeeper_Installer_V${CI_COMMIT_TAG#v}.dmg .

  artifacts:
    name: "PenPeeper-MacOS-$CI_COMMIT_TAG"
    paths:
      - "PenPeeper_Installer_V*.dmg"
    expire_in: 30 days

# ---------------------------------------------------------------------------
# LINUX BUILD JOB
# ---------------------------------------------------------------------------
# ---------------------------------------------------------------------------
# LINUX BUILD JOB (With FPM Packaging)
# ---------------------------------------------------------------------------
linux_release:
  stage: build
  tags:
    - linux
    - flutter
  rules:
    - if: $CI_COMMIT_TAG
  before_script:
    # Install required build tools for Flutter Linux builds
    #- sudo apt-get update -qq
    # sudo apt-get install -y lld clang cmake ninja-build pkg-config libgtk-3-dev
    # Ensure this matches your specific path
    - export PATH="$PATH:/home/chetstriker/tools/flutter/bin"
    - git remote set-url origin $REPO_URL
    - git fetch --all
    - git checkout $CI_COMMIT_SHA
  script:
    - flutter --version
    - flutter config --enable-linux-desktop
    - export CLEAN_VERSION=${CI_COMMIT_TAG#v}
    - 'sed -i "s/^version: .*/version: $CLEAN_VERSION/" pubspec.yaml'
    - flutter pub get
    - flutter build web --release --wasm
    - flutter build linux --release

    # --- PACKAGING PREPARATION ---
    # 1. Create a "fake" file system tree in a folder named 'staging'
    - mkdir -p staging/opt/penpeeper
    - mkdir -p staging/usr/bin
    - mkdir -p staging/usr/share/applications
    - mkdir -p staging/usr/share/pixmaps

    # 2. Copy the build artifacts to /opt/penpeeper
    - cp -r build/linux/x64/release/bundle/* staging/opt/penpeeper/

    # 3. Copy the pre-built web assets to /opt/penpeeper/build/web
    - mkdir -p staging/opt/penpeeper/build
    - cp -r build/web staging/opt/penpeeper/build/

    # 4. Create a symlink so users can type 'penpeeper' from anywhere
    #    (Linking to the executable inside /opt)
    - ln -s /opt/penpeeper/penpeeper staging/usr/bin/penpeeper

    # 5. Install .desktop file for application menu integration
    - cp linux/penpeeper.desktop staging/usr/share/applications/

    # 6. Install application icon
    - cp linux/runner/resources/window_icon.png staging/usr/share/pixmaps/penpeeper.png

    # 7. Make the binary executable (ensure it has proper permissions)
    - chmod +x staging/opt/penpeeper/penpeeper

    # --- FPM PACKAGING COMMANDS ---
    # Note: We use ${CI_COMMIT_TAG#v} to strip the 'v' from 'v1.0.0' because RPM forbids 'v' in versions.

    # 1. DEB (Debian/Ubuntu/Kali) - Standard
    - fpm -s dir -t deb --name penpeeper --version ${CI_COMMIT_TAG#v} --architecture x86_64 --depends libgtk-3-0 --description "PenPeeper Security Tool" --maintainer "chetstriker" --after-install linux/post-install.sh -C staging .

    # 2. RPM (RedHat / Fedora / CentOS / AlmaLinux)
    #    Uses dependency 'gtk3'
    - fpm -s dir -t rpm --name penpeeper --version ${CI_COMMIT_TAG#v} --architecture x86_64 --depends gtk3 --description "PenPeeper Security Tool" --maintainer "chetstriker" --after-install linux/post-install.sh -p "penpeeper-${CI_COMMIT_TAG#v}-RH-Fed-Cent_Alma.x86_64.rpm" -C staging .

    # 3. RPM (OpenSUSE / SLES)
    #    Uses dependency 'libgtk-3-0' and we add a suffix to the filename so they don't overwrite
    #    -p flag manually sets the output filename
    - fpm -s dir -t rpm --name penpeeper --version ${CI_COMMIT_TAG#v} --architecture x86_64 --depends libgtk-3-0 --description "PenPeeper for openSUSE" --maintainer "chetstriker" --after-install linux/post-install.sh -p "penpeeper-${CI_COMMIT_TAG#v}-opensuse.x86_64.rpm" -C staging .

    # 4. Pacman (Arch Linux)
    - fpm -s dir -t pacman --name penpeeper --version ${CI_COMMIT_TAG#v} --architecture x86_64 --depends gtk3 --description "PenPeeper Security Tool" --maintainer "chetstriker" --after-install linux/post-install.sh -C staging .

  artifacts:
    name: "PenPeeper-Linux-$CI_COMMIT_TAG"
    paths:
      - "*.deb"
      - "*.rpm"        # This captures both RPMs
      - "*.pkg.tar.zst"
    expire_in: 30 days

# ---------------------------------------------------------------------------
# RELEASE CREATION JOB
# ---------------------------------------------------------------------------
create_release:
  stage: release
  tags:
    - windows
  needs:
    - job: windows_release
      artifacts: false
    - job: macos_release
      artifacts: false
    - job: linux_release    # <--- Add this
      artifacts: false
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "Creating GitLab release for $CI_COMMIT_TAG"
  release:
    tag_name: "$CI_COMMIT_TAG"
    name: "PenPeeper $CI_COMMIT_TAG"
    description: |
      Cross-platform release for PenPeeper.

      **Installation:**
      - **Windows:** Download and run the installer executable.
      - **macOS:** Download the DMG, open it, and drag PenPeeper.app to your Applications folder.
      - **Linux:** Download the appropriate package for your distribution and install.
    assets:
      links:
        - name: "Windows Build - Files"
          url: "$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/download?job=windows_release"
        - name: "MacOS Build - DMG"
          url: "$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/download?job=macos_release"
        - name: "Linux - DEB - Debian or Ubuntu"
          url: "$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/penpeeper_${CI_COMMIT_TAG#v}_amd64.deb?job=linux_release"
        - name: "Linux - RPM - Fedora or RHEL"
          url: "$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/penpeeper-${CI_COMMIT_TAG#v}-RH-Fed-Cent_Alma.x86_64.rpm?job=linux_release"
        - name: "Linux - RPM - OpenSUSE"
          url: "$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/penpeeper-${CI_COMMIT_TAG#v}-opensuse.x86_64.rpm?job=linux_release"
        - name: "Linux - Pacman - Arch Linux"
          url: "$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/penpeeper-${CI_COMMIT_TAG#v}-1-x86_64.pkg.tar.zst?job=linux_release"